var _apiUrl=null,_apiKey="XRFhwNDIyQDMxMzcyZTMyMmUzMlTclR21RaFh",_apiSecret="TclR2Y1dE4vdkNPT09GJwRzvKzhialRCTclRA",_mapBoxPublicToken="pk.eyJ1IjoiZGV2LXB0ZGkiLCJhIjoiY2tmZHBnZWM5MDlqejJ6bmVxbWJndWowNCJ9.HdpiDmcwWSzPba_OrX3Rxw",_map=null,_realtime=null,_deviceList=$("#device-list"),_vins=[],_markerPos=[],_markers=[],_markerGroup=null,_latLngBounds=[],_selectedVin=null,_selectedIndex=-1,_carIcon=null,_carIconSelected=null;function getLocations(){const url=_apiUrl,apiKey=_apiKey,apiSecret=_apiSecret,params={lang:"en",token:getUrlVars().token},headers={api_key:apiKey,api_secret:apiSecret};ajaxCallPost(url,headers,params,(function(result){if(result.result){const payload=result.payload;_markerPos=[],_markers=[],_deviceList.empty(),_latLngBounds=L.latLngBounds(),_map.removeLayer(_markerGroup),_markerGroup=L.layerGroup().addTo(_map),payload.is_expired?alert("Token expired"):(_vins=payload.vins).length>0&&($.each(_vins,(function(i,e){const coords=e.coords;let html='<div class="card mb-3">';html+='<div class="card-header" id="heading-'+e.vin+'">',html+='<h5 class="mb-0">',html+='<button class="btn btn-link btn-select-vin" data-toggle="collapse" data-name="'+e.name+'" data-vin="'+e.vin+'" data-index="'+i+'" data-target="#collapse-'+e.vin+'" aria-expanded="true" aria-controls="collapse-'+e.vin+'">'+e.name+"</button>",html+="</h5>",html+="</div>",html+='<div id="collapse-'+e.vin+'" class="collapse '+(i==_selectedIndex?"show":"")+'" aria-labelledby="heading-'+e.vin+'" data-parent="#device-list">',html+='<div class="card-body">',html+='<table class="table table-bordered table-hover table-sm mb-0 small">',html+='<tr><td style="width: 25%;">Plate Number</td><td class="text-right font-weight-bold">'+e.name+"</td></tr>",html+='<tr><td>VIN</td><td class="text-right">'+e.vin+"</td></tr>",html+='<tr><td>Status</td><td class="text-right '+("offline"===e.status?"text-danger":"online"===e.status?"text-success":"text-warning")+'">'+e.status+"</td></tr>",html+='<tr><td>Ignition</td><td class="text-right">'+(e.ignition?"On":"Off")+"</td></tr>",html+='<tr><td>Signal Strength</td><td class="text-right">'+e.rssi/5*100+"%</td></tr>",html+='<tr><td>Battery Level</td><td class="text-right">'+e.battery+"%</td></tr>",html+='<tr><td>Speed</td><td class="text-right">'+$.number(coords.speed,2)+" KM/H</td></tr>",html+='<tr><td>Odometer</td><td class="text-right">'+$.number(e.odometer/1e3,2)+" KM</td></tr>",html+='<tr><td>Total Distance</td><td class="text-right">'+$.number(e.total_distance/1e3)+" KM/H</td></tr>",html+='<tr><td>Latitude</td><td class="text-right">'+coords.lat+"</td></tr>",html+='<tr><td>Longitude</td><td class="text-right">'+coords.lon+"</td></tr>",html+='<tr><td>Accuracy</td><td class="text-right">'+coords.accuracy+"</td></tr>",html+='<tr><td>Address</td><td class="text-right">'+coords.address+"</td></tr>",html+='<tr><td>Alarm</td><td class="text-right text-danger font-weight-bold">'+e.alarm+"</td></tr>",html+='<tr><td>Geofence</td><td class="text-right">'+(coords.geofence.length>0?"Yes":"No")+"</td></tr>",html+="</table>",html+="</div>",html+="</div>",html+="</div>",_deviceList.append(html);const marker=L.marker([coords.lat,coords.lon],{icon:_carIcon}).addTo(_markerGroup).bindTooltip("<strong>"+e.name+"</strong>",{offset:[0,-50],direction:"top",permanent:!0}).openTooltip();_markers.push(marker),_latLngBounds.extend([coords.lat,coords.lon])})),$(".btn-select-vin").on("click",(function(){selectVin($(this).data("index"))})),-1==_selectedIndex?_map.fitBounds(_latLngBounds):selectVin(_selectedIndex))}else alert(result.msg)}))}function selectVin(index){for(let i=0;i<_markers.length;i++){const prevTooltip=_markers[i].getTooltip();prevTooltip.options.offset=[0,-50],_markers[i].unbindTooltip(),_markers[i].setIcon(_carIcon).bindTooltip(prevTooltip)}_selectedIndex=index;const marker=_markers[index],tooltip=marker.getTooltip();tooltip.options.offset=[0,-68],marker.unbindTooltip(),marker.setIcon(_carIconSelected).bindTooltip(tooltip),_map.setView(marker.getLatLng(),20)}function updatePosition(){const url=_apiUrl,apiKey=_apiKey,apiSecret=_apiSecret,params={lang:"en",token:getUrlVars().token},headers={api_key:apiKey,api_secret:apiSecret};ajaxCallPost(url,headers,params,(function(result){if(result.result){const payload=result.payload;if(_latLngBounds=L.latLngBounds(),payload.is_expired)alert("Token expired");else{const vins=payload.vins;_latLngBounds=L.latLngBounds(),vins.length>0&&($.each(vins,(function(i,e){const coords=e.coords,index=_.findIndex(_vins,{vin:e.vin});_markers[index].setLatLng([coords.lat,coords.lon]),_latLngBounds.extend([coords.lat,coords.lon])})),-1==_selectedIndex?_map.fitBounds(_latLngBounds):selectVin(_selectedIndex))}}else alert(result.msg)}))}function getUrlVars(){for(var vars=[],hash,hashes=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),i=0;i<hashes.length;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars}function ajaxCallPost(url,headers,data,callback){$.ajax({url:url,data:JSON.stringify(data),type:"post",dataType:"json",headers:headers,contentType:"application/json; charset=utf-8",success:function(result){callback(result)}})}$((function(){_carIcon=L.icon({iconUrl:"images/car-marker-32.png",iconSize:[48,48],iconAnchor:[24,48],popupAnchor:[0,-50]}),_carIconSelected=L.icon({iconUrl:"images/car-marker-64.png",iconSize:[64,64],iconAnchor:[32,64]}),$.getJSON("config.json",(function(result){"development"===result.environment?_apiUrl="http://gps.bataviarent.com/prime/iot/v1/api/Traccar/Get_Token_InfoAsync":"production"===result.environment&&(_apiUrl="http://localhost:5000/Traccar/Get_Token_InfoAsync"),navigator.geolocation?navigator.geolocation.getCurrentPosition((function(pos){const coords=pos.coords;_map=L.map("map").setView([coords.latitude,coords.longitude],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(_map),_markerGroup=L.layerGroup().addTo(_map),getLocations()}),(function(err){alert("Maps Error: "+err)})):alert("Please allow location request")}))})),setInterval(updatePosition,5e3);